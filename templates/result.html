<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GPX Processing Results</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 1.5rem; background: #f8f9fb; color: #1f2329; }
        main { max-width: 1100px; margin: auto; }
        h1 { margin-bottom: 0.5rem; }
        pre {
            background: #f1f4f8;
            padding: 1rem;
            border-radius: 8px;
            white-space: pre-wrap;
            border: 1px solid #e2e8f0;
        }
        .status { font-weight: 600; margin: 1rem 0; }
        .ok { color: #1a7f37; }
        .fail { color: #c62828; }
        .button {
            display: inline-block;
            padding: 0.65rem 1.3rem;
            border-radius: 6px;
            background: #1f6feb;
            color: white;
            text-decoration: none;
            margin-right: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .button:hover { background: #1b5fd0; }
        .panel { background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #d0d7de; box-shadow: 0 8px 24px rgba(140,149,159,0.15); margin-bottom: 1.5rem; }
        .stats-list { list-style: none; margin: 0; padding: 0; }
        .stats-list > li { padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0; }
        .stats-list > li:last-child { border-bottom: none; }
        .stat-row { display: flex; align-items: center; justify-content: space-between; gap: 1rem; font-weight: 500; color: #1f2329; }
        .stat-value { color: #343a40; font-variant-numeric: tabular-nums; }
        .stats-sublist { list-style: none; margin: 0.35rem 0 0 0; padding: 0; color: #4a5568; font-size: 0.95rem; }
        .stats-sublist li { padding: 0.15rem 0; }
        footer { margin-top: 2rem; font-size: 0.95rem; }
    </style>
</head>
<body>
    <main>
        <h1>GPX Processing Results</h1>
        <p class="status {{ 'ok' if success else 'fail' }}">
            {{ "✓ Processing completed successfully." if success else "✗ Processing failed." }}
        </p>

        {% if success %}
        <div class="panel">
            <h2>Outputs</h2>
            <p style="color:#555;">Download the enriched GPX file or open the generated static map in a new tab.</p>
            {% if distance_step and search_radius %}
            <p style="margin-top:0.5rem;color:#5b6168;font-size:0.95rem;">Parameters: sample distance {{ distance_step }}&nbsp;m · search radius {{ search_radius }}&nbsp;m.</p>
            {% endif %}
            {% if no_cache %}
            <p style="margin-top:0.25rem;color:#5b6168;font-size:0.9rem;">Cache disabled for this run.</p>
            {% endif %}
            <div>
                {% if gpx_file %}
                <a class="button" href="{{ url_for('download', job_id=job_id, filename=gpx_file) }}">Download Enriched GPX</a>
                {% endif %}
                {% if map_file %}
                <a class="button" href="{{ url_for('download', job_id=job_id, filename=map_file) }}">Download Static HTML Map</a>
                <a class="button" style="background:#0369a1;" href="{{ map_url }}" target="_blank" rel="noopener">Open Map in New Tab</a>
                {% endif %}
                {% if success and original_filename %}
                <a class="button" style="background:#5b636a;" href="{{ url_for('configure', job_id=job_id, filename=original_filename, distance_step=distance_step, search_radius=search_radius, no_cache='1' if no_cache else '0') }}">Adjust Parameters</a>
                {% endif %}
                <a class="button" style="background:#444c56;" href="{{ url_for('index') }}">Upload New GPX</a>
            </div>
        </div>
        {% endif %}

        {% if map_stats %}
        <div class="panel">
            <h2>Map Statistics</h2>
            <p style="color:#555;">Quick snapshot of what the map generator found.</p>
            <ul class="stats-list">
                {% for item in map_stats %}
                <li>
                    <div class="stat-row">
                        <span class="stat-label">{{ item.label }}</span>
                        {% if item.value %}
                        <span class="stat-value">{{ item.value }}</span>
                        {% endif %}
                    </div>
                    {% if item.children %}
                    <ul class="stats-sublist">
                        {% for child in item.children %}
                        <li>{{ child.label }}{% if child.value %}: {{ child.value }}{% endif %}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="panel">
            <h2>Standard Error</h2>
            <pre>{{ stderr or "(no errors)" }}</pre>
        </div>

        <footer>
            <a href="{{ url_for('index') }}">← Back to Upload</a>
        </footer>
    </main>
</body>
</html>
